---
title: "Trabajo 2. Decisión Multicriterio"
subtitle: "Teoría de la decisión"
author: "Marta Venegas Pardo"
date: "11/9/2021"
output: 
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
    toc: true
    toc_depth: 4
    number_section: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r  message=FALSE }
source("ScriptsNecesarios/teoriadecision_funciones_multicriterio.R")
#source("ScriptsNecesarios/teoriadecision_funciones_multicriterio_diagram.R")
source("ScriptsNecesarios/teoriadecision_funciones_multicriterio_utiles.R")
```

## Enunciado

Luis hace su último año de residencia de anestesia en el hospital General Universitario de Ciudad Real, pero tiene que ir un mes a trabajar en el hospital Asepeyo en un pueblo a las afueras de Madrid, por lo que va a vivirá durante un mes en Madrid Capital, pero debe ir y volver a Ciudad Real 3 veces para hacer guardias.

Debe elegir un medio de transporte entre tres posibles alternativas:

-   Alquilar una moto en Madrid para ese mes, que sería un total de 220\$ más gasolina.

-   Compar un patinete eléctrico (200 euros) y sacar un bono de metro que le permita ir y volver al hospital desde el centro por 28 euros.

Para estas dos opciones, necesitaría sacar un abono de 10 viajes de Renfe para ir y volver a Ciudad Real, por un importe de 195 euros.

-   Llevar su coche, con el que puede ir al hospital desde el centro y a Ciudad Real cuando necesite hacer las guardias. Si escoge llevar su coche, tendría que alquilar una plaza de garaje por 200 euros, además de pagar la gasolina.

Para tomar una decisión, Luis ha considerado tres criterios:

-   Seguridad

-   Precio

-   Condiciones de viaje

    -   Tiempo invertido en el/los trayecto
    -   Meteorología (frío/lluvia/nieve)

Dentro de las condiciones de viaje, considera que es importante considerar el tiempo que tardaría en llegar al hospital en función del medio de transporte elegido y las condiciones meteorológicas, que le harían tener que cambiar su itinerario.

-   Matriz comparación entre Criterios

| Criterios   | Seguridad | Condiciones | Precio |
|-------------|-----------|-------------|--------|
| Seguridad   | 1         | 9           | 7      |
| Condiciones | 1/9       | 1           | 2      |
| Precio      | 1/7       | 1/3         | 1      |

-   Matriz de ponderación de importancias dentro del criterio CONDICIONES DEL VIAJE

| Condiciones  | Tiempo(tray) | Meteorología |
|--------------|--------------|--------------|
| Tiempo(tray) | 1            | 7            |
| Meteorología | 1/7          | 1            |

-   Matriz comparación entre Alternativas según Criterios

| Seguridad | Moto | Patín   | Coche |
|-----------|------|---------|-------|
| Moto      | 1    | 1/3     | 1/7   |
| Patín     | 3    | 1       | 1/5   |
| Coche     | 7    | 5 (4\*) | 1     |

| Precio | Moto | Patín | Coche |
|--------|------|-------|-------|
| Moto   | 1    | 1/3   | 7     |
| Patín  | 3    | 1     | 5     |
| Coche  | 1/7  | 1/5   | 1     |

-   Matriz comparación entre Alternativas según Subcriterios

| Meteorología | Moto | Patín | Coche |
|--------------|------|-------|-------|
| Moto         | 1    | 1     | 1/7   |
| Patín        | 1    | 1     | 1/7   |
| Coche        | 7    | 7     | 1     |

| Tiempo | Moto | Patín | Coche |
|--------|------|-------|-------|
| Moto   | 1    | 7     | 2     |
| Patín  | 1/7  | 1     | 1/5   |
| Coche  | 1/2  | 5     | 1     |

Para conseguir una ordenación de las alternativas y obtener la mejor, tenemos la siguiente información

El decisor nos ha proporcionado los siguientes pesos preferenciales: W=(0.5,0.25,0.25)

Como ya sabíamos, para tomar una decisión, Luis ha considerado tres criterios relevantes para tomar la decisión de clasificar los tres medios de transporte para viajar durante ese mes que está en Madrid.

-   Seguridad (maximizar)
-   Precio (minimizar)
-   Condiciones de viaje (maximizar)

Ahora encontramos una table con información relevante proporcionada por Luis para resolver el problema.

| Criterio             | Min/Max | Tipo | Parámetros | Parámetros |
|----------------------|---------|------|------------|------------|
| Seguridad            | Max     | III  | q=1        |            |
| Precio               | Min     | I    | q=10       | p=30       |
| Condiciones de viaje | Max     | II   | s=3        | p=5        |

La matriz de decisión viene recogida en la siguiente tabla:

| A/C   | C1: Seguridad | C2: Precio     | C3: Condiciones |
|-------|---------------|----------------|-----------------|
| Moto  | 80            | `r 220+195`    | 90              |
| Patín | 250           | `r 200+28+195` | 100             |
| Coche | 500           | `r 200+100`    | 80              |

Para aplicar el método electre, iniciar el proceso con $\alpha=0.75$ y d=($\infty$,55,$\infty$). Es decir, para que una alternativa supere a otra en precio, debe haber como mínimo, una diferencia de 55 euros, para cantidades inferiores, consideramos que ambas alternativas son equivalentes.

Utilizar los métodos Electre y Promethee para ordenar las alternativas y obtener la mejor decisión.

## Solución con paquete AHP

```{r}
#devtools::install_github("gluc/ahp", build_vignettes = TRUE)
# ahp::RunGUI()
library(ahp)
dtMio = Load("trabajo2TD.ahp")
```

```{r message=FALSE}
Visualize(dtMio)
```

### Pesos globales. Criterios/Subcriterios y Alternativas

```{r}
ahp::Calculate(dtMio)
ahp::AnalyzeTable(dtMio, sort="orig",variable="priority")
```

### Tabla para la interpretación

```{r}
ahp::AnalyzeTable(dtMio, sort="orig")
```





# Método Promethee
## Promethee I

```{r}
tabdec.X = multicriterio.crea.matrizdecision(
  c(80,-(220+195),90,
   250,-(200+28+195),100,
   500,-(200+100),80),
  numalternativas=3,
  numcriterios=3,
  v.nombresalt=c("Moto","Patinete E","Coche"),
  v.nombrescri = c("Seguridad","Precio","Condiciones")
                                                    
)
tabdec.X
```

```{r}
wi<-c(1/2,1/4,1/4)
# Le da más importancia a la seguridad, el doble que al precio y a las condiciones del viaje
salM= multicriterio.metodo.promethee_i(
  tabdec.X,
  pesos.criterios = wi, # porque son 6 criterios, LOS PESOS DEBEN SUMAR 1
  tab.fpref=matrix(c( 3,1, 0, 0, # nro ,qi,pi,si
                      1,10,30,0,
                      2,3, 5, 0),
                   ncol=4,
                   byrow=TRUE))

  tab.fpref=matrix(c( 3,1, 0, 0, # nro ,qi,pi,si
                      1,10,30,0,
                      2,3, 5, 0),ncol=3,
                   byrow=TRUE)
salM
```




Representar en un grafo:

```{r}
qgraph::qgraph(salM$tablarelacionsupera)
```

Ir en coche domina a todos y el patinete domina a la moto. La moto no domina a ninguna alternativa.

### Medias

```{r}
# Tab.Pthee.I_med= multicriterio.metodo.promethee_i_med(
#   tabdecs.X = tabdec.X,
#    pesos.criterios = wi,
#    tab.fpref = tab.fpref)
# Tab.Pthee.I_med
```


Representar en un grafo:

```{r}
# qgraph::qgraph(Tab.Pthee.I_med$tablarelacionsupera)
```


## Promethee II

```{r}
salMPrometheeII= multicriterio.metodo.promethee_ii(
  tabdec.X,
  pesos.criterios = wi, # porque son 6 criterios, LOS PESOS DEBEN SUMAR 1
  tab.fpref=matrix(c( 3,1, 1, 0, # nro ,qi,pi,si
                      1,10,30,0,
                      2,3, 5, 0),
                   ncol=4,
                   byrow=TRUE))

  tab.fpref=matrix(c( 3,1, 1, 0, # nro ,qi,pi,si
                      1,10,30,0,
                      2,3, 5, 0),ncol=3,
                   byrow=TRUE)
salMPrometheeII
```

Representar en un grafo:

```{r}
qgraph::qgraph(salMPrometheeII$tablarelacionsupera)
```

De nuevo, ir en coche domina a todos y el patinete domina a la moto. La moto no domina a ninguna alternativa.

```{r}
order(salMPrometheeII$vflujos.netos,decreasing = T)
```

Me dice que la alternativa 3 (ir en coche) es la mejor, seguido de ir en patín y por último, la moto.




### Medias

```{r}
# Tab.Pthee.II_med_8= multicriterio.metodo.promethee_ii_med( tabdecs.X = # tabdec.X,
#                                                            pesos.criterios = # rep(1/6,6),
#                                                           tab.fpref   =  # tab.fpref)
# Tab.Pthee.II_med_8
```




Representar en un grafo:

```{r}
#qgraph::qgraph(Tab.Pthee.II_med_8$tablarelacionsupera)
```



Ordenación final con promethee II medias 

```{r}
#order(Tab.Pthee.II_med_8$vflujos.netos,decreasing = T)
```

### Comparativas con y sin medias

```{r}
#order(sal8b$vflujos.netos,decreasing = T)
```



```{r}
#order(Tab.Pthee.II_med_8$vflujos.netos,decreasing = T)
```

La ordenación es la misma.

## Representación gráfica de las funciones de preferencia


```{r}
fpref.criterio_usual_di = function(di) {
              #di = vaj-vah;
    if (di <= 0) {
      res= 0;
      } else {
        res= 1;
      }
       return(res) ;
  }
```

Representación Gráfica de las funciones de preferencias

```{r}
x= seq(-10,10 ,length.out=100)
y= sapply (x,fpref.criterio_usual_di)
plot (x,y, type="l", col="blue" ,main= "Criterio Usua: F1 ")
```

```{r}
fpref.cuasi_criterio_di = function(di,qi) {
              #di = vaj-vah;
    if (di <= qi) {
      res= 0;
      } else {
        res= 1;
      }
       return(res) ;
  }
```

```{r}
x= seq(-10,10 ,length.out=100)
y= sapply (x,function(xx) fpref.cuasi_criterio_di(xx,qi=2))
plot (x,y, type="l", col="blue" ,main= "Cuasi Criterio. Lineal: F2 (con qi=2)")
```

```{r}
fpref.criterio_preflineal_di = function(di,pi) {
              #di = vaj-vah;
    if (di <= 0) {
      res= 0;
      } else if (di>pi) {
        res= 1;
      } else {
        res=di/pi;
      }
       return(res) ;
  }
```

```{r}
x= seq(-10,10 ,length.out=100)
y= sapply (x,function(xx) fpref.criterio_preflineal_di(xx,pi=2))
plot (x,y, type="l", col="blue" ,main= "Criterio
      Pref. Lineal: F3 (con pi=2)")
```

```{r}
fpref.criterio_nivel_di = function(di,qi,pi) {
              #di = vaj-vah;
    if (di <= qi) {
      res= 0;
      } else if (di>pi) {
        res= 1;
      } else {
        res=0.5;
      }
       return(res) ;
  }
```

```{r}
x= seq(-10,10 ,length.out=100)
y= sapply (x,function(xx) fpref.criterio_nivel_di(xx,pi=4,qi=2))
plot (x,y, type="l", col="blue" ,main= "Criterio
      Nivel: F4 (con qi=2 y pi=4)")
```

```{r}
fpref.criterio_preflineal_indif_di = function(di,qi,pi) {
              #di = vaj-vah;
    if (di <= qi) {
      res= 0;
      } else if (di>pi) {
        res= 1;
      } else {
        res=(di-qi)/(pi-qi);
      }
       return(res) ;
  }
```

```{r}
x= seq(-10,10 ,length.out=100)
y= sapply (x,function(xx) fpref.criterio_preflineal_indif_di(xx,pi=4,qi=2))
plot (x,y, type="l", col="blue" ,main= "Criterio Pref. Lineal Indiferencia: F5 (con qi=2 y pi=4)")
```




# Método Electre



Método electre:

-   D
-   Alpha
-   Pesos de comparación, podríamos ponerlos todos infinitos

## Primera iteración


```{r}
salElectre=multicriterio.metodoELECTRE_I(tabdec.X,
                      pesos.criterios = wi,
                      nivel.concordancia.minimo.alpha = 0.75,
                      no.se.compensan = c(Inf,55,Inf),
                      que.alternativas = TRUE
                                   )
salElectre$nucleo_aprox
```

Representación del grafo

```{r}
qgraph::qgraph(salElectre$relacion.dominante)
```
Programar para que se hagan más iteraciones.

## Cálculos en el método electre I La representación de las tables de test con KableExtra

```{r}
library(dplyr)
library(kableExtra)
library(stringr)
salke = func_ELECTRE_Completo(salElectre)
```

```{r}
salke$MIndices
```



Comentarios respecto a la alternativa 1 A1: Ir en moto

- Gana a la la alternativa 2 (ir en patinete) en el criterio 2 (precio), por lo tanto, es peor que ir en patinete en los criterios 1 y 3 (seguridad y condiciones de viaje)
- Gana a la la alternativa 3 (ir en coche) en el criterio 3 (condiciones de viaje), y por tanto , es peor que ir en coche en los criteios 1 y 2 (seguridad y precio)
- No es igual a ninguna alternativa en ningún criterio


La alternativa 2, A2: Ir en patín




- A1 no supera a A2 en los criterios 1, 3 y 5
- En los criterios 1,3,5 a1 peor a2






```{r}
salke$TConcordancia
```



Notación:

- F= NO PASA EL TEST DE CONCORDANCIA
- RESULTADO AZUL: PAREJAS QUE PASAN EL TEST DE CONCORDANCIA

Sólo pasan el test de corcondancia:

- A2SA1: Ir en patín supera a ir en moto
- A3SA1: Ir en coche supera a ir en moto
- A3SA2: Ir en coche supera a ir en patin


```{r}
salke$TDiscordancia
```

Notación:

- F= NO PASA EL TEST DE DISCORDANCIA
- RESULTADO AZUL: PAREJAS QUE PASAN EL TEST DE DISCORDANCIA
- LA DIAGONAL SE SUPERA ENTERA PERO NO VA A INFLUIR

Las alternativas que pasaban el test de concordancia también pasan el de discordancia, son:

- A2SA1: Ir en patín supera a ir en moto
- A3SA1: Ir en coche supera a ir en moto
- A3SA2: Ir en coche supera a ir en patin




```{r}
salke$TSuperacion$KE
```

CONCLUSIÓN:

- A2SA1: Ir en patín supera a ir en moto
- A3SA1: Ir en coche supera a ir en moto
- A3SA2: Ir en coche supera a ir en patin


```{r}
salke$Grafo
```



```{r}
qgraph::qgraph(salke$Grafo)
```

El núcleo

```{r}
salke$Nucleo
```

Por tanto, la mejor alternativa es la 3, ir en coche. Segundo, ir en patinete y por último, ir en moto sería la última alternativa a elegir.












# VERSIONES

## Matriz de comparación entre criterios

En la versión 1, teníamos la siguiente matriz de comparación entre criterios:

| Criterios   | Seguridad | Condiciones | Precio |
|-------------|-----------|-------------|--------|
| Seguridad   | 1         | 9           | 7      |
| Condiciones | 1/9       | 1           | 3      |
| Precio      | 1/7       | 1/3         | 1      |

Con estos datos, obtenemos una inconsistencia del 19.6%. Por ello, y trás haber revisado los pesos, hemos obtenido la siguiente matriz de comparación:

| Criterios   | Seguridad | Condiciones | Precio |
|-------------|-----------|-------------|--------|
| Seguridad   | 1         | 9           | 7      |
| Condiciones | 1/9       | 1           | 2      |
| Precio      | 1/7       | 1/2         | 1      |

Ahora la inconsistencia es menor del 10%

## Matriz de comparación entre alternativas según criterios

En el criterio *seguridad*, teníamos una inconsistencia del 9% inicialmente, con la siguiente matríz de comparaciones:

| Seguridad | Moto | Patín   | Coche |
|-----------|------|---------|-------|
| Moto      | 1    | 1/3     | 1/7   |
| Patín     | 3    | 1       | 1/5   |
| Coche     | 7    | 5 (4\*) | 1     |

Por tanto, cambiando la matriz obtenemos una inconsistencia del 5.1%:

| Seguridad | Moto | Patín | Coche |
|-----------|------|-------|-------|
| Moto      | 1    | 1/3   | 1/7   |
| Patín     | 3    | 1     | 1/4   |
| Coche     | 7    | 4     | 1     |
